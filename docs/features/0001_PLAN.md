# 0001 — Admin-Only API + Admin Frontend Migration (Lightweight Monorepo)

This plan guides building a new lightweight monorepo that keeps the Admin (Next.js) as-is and implements only the Admin‑required API endpoints in NestJS, while preparing for a future Webapp package. It references the current repo for code and DB understanding but avoids copying non‑admin features.

## Context
- New repo root: `/Users/vikasahlawat/Documents/Club-Corra-Pilot-2`
- Keep Admin on Vercel; API on AWS EC2 with existing systemd scripts
- No shared workspace package; Admin and API are isolated
- Future: add `apps/webapp` from an external repo

## Directory Targets (new repo)
- Admin: `/apps/admin`
- API: `/apps/api`
- Deploy scripts: `/scripts/deployment`
- Docs: `/docs`, plan file: `/docs/features/0001_PLAN.md`

## Admin-Used Backend Endpoints (from current repo)
- Auth
  - `POST /auth/admin/login` → current: `apps/api/src/auth/auth.controller.ts` and `auth.service.ts` (method `adminLogin`)
  - `POST /auth/admin/verify` (JWT) → current: `auth.controller.ts` guarded by `JwtAuthGuard` and `AdminGuard`, validated by `jwt.strategy.ts`
- Dashboard
  - `/admin/dashboard/*` (metrics, analytics, saved-views, risk, etc.) → current: `apps/api/src/admin/dashboard.controller.ts`, `dashboard.service.ts`
- Coins / Transactions (Admin)
  - `/admin/coins/transactions`, `/admin/coins/transactions/pending`, user verification/summary endpoints → current: `apps/api/src/coins/controllers/coin-admin.controller.ts`, `coins.service.ts`
- Users (Admin)
  - `/admin/users/*` (list, stats, get by id, updates) → current: admin user operations scattered under `apps/api/src/admin` and `apps/api/src/users/*`
- Brands & Categories
  - `/brands/*`, `/brand-categories/*` → current: `apps/api/src/brands/*.ts` (controller, service, entities)
- Form Submissions
  - `/admin/form-submissions/partner-applications`, `/admin/form-submissions/waitlist-entries` → current: `apps/api/src/admin/form-submissions.controller.ts` (uses `partners` and `waitlist` services)

Keep only modules necessary for these endpoints.

## Phase 1 — Repo Bootstrap (already done)
- Paths created in new repo:
  - `/apps/admin`, `/apps/api`, `/scripts/deployment`, `/docs`, `/.github/workflows`
  - `/.yarnrc.yml`, `/package.json`, `/turbo.json`, `/tsconfig.base.json`, `/README.md`
  - `/docs/WORKPLAN.md`, `/docs/INDEX_MAP.md`
  - `/scripts/deployment/*` copied from current repo

## Phase 2 — Admin Frontend Migration (as‑is)
- Copy from current repo (DO NOT run now; listed for reference):
  - from: `/Users/vikasahlawat/Documents/club-corra-pilot/apps/admin/*`
  - to:   `/Users/vikasahlawat/Documents/Club-Corra-Pilot-2/apps/admin/`
- Ensure Vercel config and env:
  - `/apps/admin/vercel.json`, `/apps/admin/next.config.js`, `/apps/admin/env.template`
  - `NEXT_PUBLIC_API_BASE_URL` points to EC2 reverse proxy `https://<ec2>:8080/api/v1`
- Admin HTTP client references in current repo you can mimic if needed:
  - `apps/admin/src/lib/api.ts`, `apps/admin/src/lib/dashboardApi.ts`
  - `apps/admin/src/contexts/AuthContext.tsx` → uses `/auth/admin/login` and `/auth/admin/verify`

## Phase 3 — API Skeleton (NestJS) for Admin‑Only
Create minimal Nest app with modules ONLY for admin usage.

- Create files in new repo:
  - `/apps/api/src/main.ts` — bootstrap with `ValidationPipe({ whitelist: true, transform: true })`; CORS restricted to Vercel domains + wildcard
  - `/apps/api/src/app.module.ts` — imports modules listed below
  - `/apps/api/src/config/typeorm.config.ts` and `/apps/api/src/data-source.ts` — `synchronize: false`, migrations path, SSL by env
  - `/apps/api/src/auth/*` — `auth.controller.ts` with `admin/login` and `admin/verify`, `jwt.strategy.ts`, `jwt-auth.guard.ts`, `admin.guard.ts`
  - `/apps/api/src/admin/*` — `dashboard.controller.ts`, `dashboard.service.ts`, `admin.controller.ts` (management), `form-submissions.controller.ts`
  - `/apps/api/src/coins/*` — include admin controller and relevant service methods
  - `/apps/api/src/brands/*` — controllers/services/entities for brands and categories used by Admin
  - `/apps/api/src/users/*` — minimal services/entities used by Admin pages (list/stats/get/update)
  - `/apps/api/src/partners/*`, `/apps/api/src/waitlist/*` — services/entities because Admin fetches these
  - `/apps/api/src/common/*` — common pipes, interceptors, exceptions as needed

Reference implementations (do not copy wholesale):
- Auth: `apps/api/src/auth/auth.controller.ts`, `auth.service.ts`, `strategies/jwt.strategy.ts`
- Admin: `apps/api/src/admin/admin.module.ts`, `dashboard.controller.ts`, `dashboard.service.ts`, `admin.controller.ts`, `form-submissions.controller.ts`
- Coins: `apps/api/src/coins/controllers/coin-admin.controller.ts`, `coins.service.ts`
- Brands: `apps/api/src/brands/brands.controller.ts`, `brands.service.ts`, `brand-categories.controller.ts`

## Phase 4 — Entities & Migrations (Admin‑only DB schema)
- Collect only entities required by Admin endpoints:
  - `Admin`, `User`, `UserProfile`, `CoinBalance`, `CoinTransaction`, `Brand`, `BrandCategory`, `Offer`, `Location`, `DashboardMetricsCache`, `SavedView`, `RiskSignal`, `AuditLog`, `ExperimentConfig`, `PartnerApplication`, `WaitlistEntry`
- Reference current repo entities:
  - `apps/api/src/admin/admin.entity.ts`
  - `apps/api/src/users/entities/*.entity.ts`
  - `apps/api/src/coins/entities/*.entity.ts`
  - `apps/api/src/brands/entities/*.entity.ts`
  - `apps/api/src/admin/entities/*.entity.ts`
  - `packages/shared/entities/partner-application.entity.ts`, `packages/shared/entities/waitlist-entry.entity.ts` (If present; otherwise check `apps/api/src/...`)
- TypeORM config in new repo: `/apps/api/src/data-source.ts`
- Create migrations:
  - `/apps/api/package.json` scripts: `migration:generate`, `migration:run`, `migration:revert`, `migration:show`
  - Generate initial migration from selected entities, then prune

## Phase 5 — Admin Controllers/Services Implementation
Implement minimal surface matching Admin’s calls:
- Auth
  - `POST /auth/admin/login`, `POST /auth/admin/verify`
- Dashboard
  - `GET /admin/dashboard/metrics`, `GET /admin/dashboard/metrics/realtime`
  - Analytics endpoints used in Admin dashboard
  - Saved views and risk endpoints if used by UI
- Coins/Transactions (Admin)
  - `GET /admin/coins/transactions`, `GET /admin/coins/transactions/pending`, user verification/data helpers
- Users (Admin)
  - `GET /admin/users`, `GET /admin/users/stats`, `GET /admin/users/:id`, updates (`/profile`, `/email`, `/status`)
- Brands/Categories
  - `/brands`, `/brands/:id`, `/brands/active`, `/brands/category/:id`, `/brand-categories` basic CRUD
- Form Submissions
  - `/admin/form-submissions/partner-applications`, `/admin/form-submissions/waitlist-entries`

Use guards: `JwtAuthGuard`, `AdminGuard`. Ensure role checks for ADMIN/SUPER_ADMIN.

## Phase 6 — Deployment: EC2 Systemd
- Reuse scripts already copied into `/scripts/deployment`:
  - `deploy-production-ec2.sh`, `deploy-production-ec2-optimized.sh`, `monitor-backend.sh`, `setup-log-rotation.sh`, `setup-https-backend.sh`, `club-corra-api.service`, `logrotate-club-corra-api`
- Adjust scripts to build only `/apps/api` (no shared package)
- On EC2: run deployment script, then run migrations with `DATABASE_URL`

## Phase 7 — CI/CD
- Add GitHub Actions (skeleton) under `/.github/workflows`:
  - `ci.yml`: lint, typecheck, test, build using Turbo
  - `deploy-stage.yml`: deploy Admin to Vercel stage; run EC2 deploy script
  - `deploy-production.yml`: manual approval; deploy Admin to Vercel prod; EC2 deploy; run migrations
- Node 20+ in CI; keep `nodeLinker: node-modules`

## Phase 8 — Observability & Security
- Enable Sentry DSN in Admin and API
- Enable Pino logs in API; consider CloudWatch agent on EC2
- Add CORS restrictions to Vercel domains and wildcard subdomains
- Use signed S3 URLs for any uploads

## Phase 9 — Future Webapp
- Add `/apps/webapp` from external repo
- Independent package, no shared workspace dependency
- Add Vercel deployment workflow; update `docs/INDEX_MAP.md`

## Cursor Agent Execution Hints
- Start each phase by opening target directories per plan
- Use exact references above from current repo to port logic selectively
- After implementing modules, immediately wire migrations and run locally
- After each major step: run `yarn lint && yarn typecheck && yarn test`

